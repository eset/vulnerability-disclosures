# CVE-2022-1892

## Description

UEFI BIOS images of the several Lenovo laptop models contained buffer overflow
leading to arbitrary code execution while processing the "OilSetup" NVRAM
variable (namespace ``88D1911C-AB4A-4335-9e9a-26BE9081ACC3``) inside
``SystemBootManagerDxe`` DXE driver.

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-91369](https://support.lenovo.com/us/en/product_security/LEN-91369).

## Impact

High - The vulnerability can be exploited to achieve arbitrary code execution
in the early phases of the platform boot, possibly allowing the attackers to
hijack the OS execution flow and disable some important security features
during system startup or deploy OS payload.

## Exploitability

High - Attacker with local admin privileges could exploit this vulnerability
from usermode simply by creating or modifying "OilSetup" NVRAM variable using
Windows API function ``SetFirmwareEnvironmentVariableExA``.

## Technical Details

``SystemBootManagerDxe`` driver on affected devices contains a following function sub_16B40:

```c
    __int64 __fastcall sub_16B40(__int64 a1){
        ...
        result = gRT->GetVariable(aOilsetup, &VendorGuid, 0i64, &DataSize, Data);
        if ( result == EFI_BUFFER_TOO_SMALL ){
            result = gRT->GetVariable(aOilsetup, &VendorGuid, 0i64, &DataSize, Data);
            ...
        }
    }
```

sub_16B40 function invokes ``EFI_RUNTIME_SERVICES->GetVariable`` function
twice. If the first call fails with ``EFI_BUFFER_TOO_SMALL``, it will invoke
``GetVariable`` again, without validating the new value of the ``DataSize``
variable. If an attacker modifies "OilSetup" NVRAM variable in a way that it
contains more than 0x78 bytes, second ``GetVariable`` call inside sub_16B40
would overwrite sub_16B40's return address what would lead to arbitrary code
execution.

## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-91369.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 18 February 2022    — Issue reported to Lenovo
- 18 February 2022    — Lenovo responded and confirmed to investigate the issue
- 15 May 2022         — Lenovo confirmed the vulnerability and informed us
                        about the planned advisory publication date (June 12th)
- 12 June 2022        — Lenovo security advisory published
- 13 June 2022        — ESET's public disclosure

## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-1892
- https://support.lenovo.com/us/en/product_security/LEN-91369
