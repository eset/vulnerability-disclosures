# CVE-2022-1890

## Description

UEFI BIOS images of the several Lenovo laptop models contained buffer overflow
vulnerability leading to arbitrary code execution while processing the "System"
NVRAM variable (namespace ``E947FCF9-DD01-4965-b808-32a7b6815657``) inside
``ReadyBootDxe`` DXE driver.

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-91369](https://support.lenovo.com/us/en/product_security/LEN-91369).

## Impact

High - The vulnerability can be exploited to achieve arbitrary code execution
in the early phases of the platform boot, possibly allowing the attackers to
hijack the OS execution flow and disable some important security features
during system startup or deploy stealth persitent OS payload.

## Exploitability

Medium - On affected devices, “System” NVRAM variable is write-protected during
the OS runtime, therefore attacker needs to modify this variable in the earlier
phases of the boot process. Attacker with local access could do it by booting
into UEFI shell and modify System NVRAM variable using the setvar command.

## Technical Details

``ReadyBootDxe`` driver registers ``NotifyFunction`` triggered by the
``EFI_EVENT_READY_TO_BOOT`` event.

```c
void __fastcall NotifyFunction(EFI_EVENT Event, void *Context)
{
  EFI_GUID VendorGuid; // [rsp+30h] [rbp-50h] BYREF
  char Data[64]; // [rsp+40h] [rbp-40h] BYREF
  UINTN DataSize; // [rsp+A0h] [rbp+20h] BYREF

  DataSize = 0i64;
  VendorGuid.Data1 = 0xE947FCF9;
  *&VendorGuid.Data2 = 0x4965DD01;
  *VendorGuid.Data4 = 0xA73208B8;
  *&VendorGuid.Data4[4] = 0x575681B6;
  if ( gRT->GetVariable(aSystem, &VendorGuid, 0i64, &DataSize, Data) == EFI_BUFFER_TOO_SMALL )
  {
    sub_2A0(Data, 63ui64);
    gRT->GetVariable(aSystem, &VendorGuid, 0i64, &DataSize, Data);
  }
  return 0i64;
}
```

This ``NotifyFunction`` invokes ``EFI_RUNTIME_SERVICES->GetVariable`` function
twice. If the first call fails with ``EFI_BUFFER_TOO_SMALL``, it zeroes
``Data`` buffer (with fixed value 63) and invokes ``GetVariable`` again without
validating the new value of the ``DataSize`` variable. If an attacker modifies
"System" NVRAM variable in a way that it contains more than 0x48 bytes, second
``GetVariable`` call inside ``NotifyFunction`` would overwrite
``NotifyFunction``'s return address what would lead to arbitrary code execution
after returning from the ``NotifyFunction``.

## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-91369.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 18 February 2022    — Issue reported to Lenovo
- 18 February 2022    — Lenovo responded and confirmed to investigate the issue
- 15 May 2022         — Lenovo confirmed the vulnerability and informed us
                        about the planned advisory publication date (June 12th)
- 12 June 2022        — Lenovo security advisory published
- 13 June 2022        — ESET's public disclosure

## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-1890
- https://support.lenovo.com/us/en/product_security/LEN-91369
