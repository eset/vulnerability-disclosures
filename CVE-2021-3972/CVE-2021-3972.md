# CVE-2021-3972

## Description

UEFI BIOS images of the several Lenovo consumer laptop models contained a
special driver (namely ``ChgBootDxeHook`` and ``ChgBootSmm``) allowing to modify
various boot configuration settings including UEFI Secure Boot state by
modifying an NVRAM variable. Affected UEFI firmware drivers were originally
meant to be used only during the manufacturing process of Lenovo consumer
notebooks but were mistakenly included also in the production BIOS images
without being properly deactivated.

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-73440](https://support.lenovo.com/us/en/product_security/LEN-73440).

List (possibly incomplete) of affected devices not included in the advisory due
to End Of Development Support (EODS):

- S740-14IIL Laptop (IdeaPad)
- Yoga S740-14IIL Laptop (IdeaPad)
- 530S-14IKB Laptop (IdeaPad)
- 530S-15IKB Laptop (IdeaPad)
- 330-14IGM Laptop (IdeaPad)
- 330-15IGM Laptop (IdeaPad)
- 330-14IKB Laptop (IdeaPad)
- 330-15IKB Laptop (IdeaPad)

## Impact

High - Disabled UEFI Secure Boot exposes users to the risk of UEFI Bootkit installation.

## Exploitability

High/Medium - Vulnerability can be exploited from a privileged user-mode
process by simply creating special UEFI NVRAM variables. On some devices,
attacker needs to perform additional step requiring the ring-0 privileges to
exploit this vulnerability.

Created variables are being processed by the platform firmware on the next boot.


## Technical Details

When ``ChgBootDxeHook`` UEFI driver detects existence of the special UEFI NVRAM
variable(s) during the early stages of the boot, it changes appropriate boot
configuration settings associated with created NVRAM variable - e.g., if it
detects that NVRAM variable with name ``ChgBootSecureBootDisable`` exists, it
disables UEFI Secure Boot.


## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-73440.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 11 October 2021    — Issue reported to Lenovo
- 12 October 2021    — Lenovo responded and confirmed to investigate the issues
- 17 November 2021   — Lenovo confirmed the vulnerabilities and informed us
                       about the planned advisory publication date (February 8th)
- 20 January 2022    — Lenovo asked to postpone public disclosure to the new
                       advisory publication date to April 18th due to
                       encountered development problems
- 18 April 2022      — Lenovo security advisory published
- 19 April 2022      — ESET's public disclosure

## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3972
- https://support.lenovo.com/us/en/product_security/LEN-73440
- https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/
