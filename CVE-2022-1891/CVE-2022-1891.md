# CVE-2022-1891

## Description

UEFI BIOS images of the several Lenovo laptop models contained buffer overflow
vulnerability leading to arbitrary code execution while processing the "System"
NVRAM variable (namespace ``E947FCF9-DD01-4965-b808-32a7b6815657``) inside
``SystemLoadDefaultDxe`` DXE driver.

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-91369](https://support.lenovo.com/us/en/product_security/LEN-91369).

## Impact

High - The vulnerability can be exploited to achieve arbitrary code execution
in the early phases of the platform boot, possibly allowing the attackers to
hijack the OS execution flow and disable some important security features
during system startup or deploy OS payload.

## Exploitability

Medium - On affected devices, "System" NVRAM variable is write-protected during
the OS runtime, therefore attacker needs to modify this variable in the earlier
phases of the boot process. Attacker with local access could do it by booting
into UEFI shell and modify System NVRAM variable using the ``setvar`` command.

## Technical Details

``SystemLoadDefaultDxe`` driver on affected devices contains a following
function sub_500:

```c
__int64 __fastcall sub_500(__int64 a1){
      char Data[72]; // [rsp+30h] [rbp-48h] BYREF
      UINT32 Attributes; // [rsp+80h] [rbp+8h] BYREF
      UINTN DataSize; // [rsp+90h] [rbp+18h] BYREF
 
      *a1 = 0;
      *(a1 + 2) = 0;
      Attributes = 0;
      if ( ((gRT->GetVariable(aSystem, &gVendorGuid, &Attributes, &DataSize, Data) & 0x8000000000000000ui64) == 0i64
         || (gRT->GetVariable(aSystem, &gVendorGuid, &Attributes, &DataSize, Data) & 0x8000000000000000ui64) == 0i64)
        && Data[56] == 1 )
      {
        *a1 = 1;
      }
      return 0i64;
}
```

This function invokes ``EFI_RUNTIME_SERVICES->GetVariable`` function twice. If
the first call fails with ``EFI_BUFFER_TOO_SMALL``, it will invoke
``GetVariable`` again, without validating the new value of a ``DataSize``
variable. If an attacker modifies "System" NVRAM variable in a way that it
contains more than 0x48 bytes, second ``GetVariable`` call inside sub_500 would
overwrite sub_500's return address what would lead to arbitrary code execution
after returning from the sub_500 function.

## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-91369.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 18 February 2022    — Issue reported to Lenovo
- 18 February 2022    — Lenovo responded and confirmed to investigate the issue
- 15 May 2022         — Lenovo confirmed the vulnerability and informed us
                        about the planned advisory publication date (June 12th)
- 12 June 2022        — Lenovo security advisory published
- 13 June 2022        — ESET's public disclosure

## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-1891
- https://support.lenovo.com/us/en/product_security/LEN-91369
