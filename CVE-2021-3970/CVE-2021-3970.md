# CVE-2021-3970

## Description

``LenovoVariableSmm`` UEFI driver used in several Lenovo consumer laptop models
contains a vulnerability caused by an insufficient input validation in the
System Management Mode SMI handler function. Exploitation can lead to the SMRAM
memory modification with subsequent arbitrary code execution in the highly
privileged SMM execution mode (ring -2).

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-73440](https://support.lenovo.com/us/en/product_security/LEN-73440).

List (possibly incomplete) of affected devices not included in the advisory due
to End Of Development Support (EODS):

- S740-14IIL Laptop (IdeaPad)
- Yoga S740-14IIL Laptop (IdeaPad)
- 530S-14IKB Laptop (IdeaPad)
- 530S-15IKB Laptop (IdeaPad)
- 330-14IGM Laptop (IdeaPad)
- 330-15IGM Laptop (IdeaPad)
- 330-14IKB Laptop (IdeaPad)
- 330-15IKB Laptop (IdeaPad)

## Impact

High - Privilege escalation from ring 0 to SMM (ring -2)

## Exploitability

High/Medium - Attacker needs ring 0 privileges to exploit this vulnerability.
To exploit it, attacker needs to pass a pointer to specially crafted buffer as
a parameter to the SMI handler.

## Technical Details

``LenovoVariableSmm`` SMM module registers SMI handler function that does not
validate input parameters correctly. Attacker with elevated privileges can
trigger invocation of this SMI handler function and pass a pointer to specially
crafted buffer as a parameter to it to achieve arbitrary memory read/write
from/to SMM hardware-protected memory (SMRAM) with subsequent arbitrary code
execution with SMM privileges (ring -2).

## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-73440.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 11 October 2021    — Issue reported to Lenovo
- 12 October 2021    — Lenovo responded and confirmed to investigate the issues
- 17 November 2021   — Lenovo confirmed the vulnerabilities and informed us
                       about the planned advisory publication date (February 8th)
- 20 January 2022    — Lenovo asked to postpone public disclosure to the new
                       advisory publication date to April 18th due to
                       encountered development problems
- 18 April 2022      — Lenovo security advisory published
- 19 April 2022      — ESET's public disclosure


## References

- <https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3970>
- <https://support.lenovo.com/us/en/product_security/LEN-73440>
- <https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/>
