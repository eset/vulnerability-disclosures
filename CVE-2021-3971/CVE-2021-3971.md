# CVE-2021-3971

## Description

UEFI BIOS images of the several Lenovo consumer laptop models contained a
special drivers (namely ``SecureBackDoor`` and ``SecureBackDoorPeim``) allowing
to disable SPI flash firmware storage protections by modifying an NVRAM
variable. Affected UEFI firmware drivers were originally meant to be used only
during the manufacturing process of Lenovo consumer notebooks but were
mistakenly included also in the production BIOS images without being properly
deactivated.

List of affected devices with active development support can be found in
Lenovo's security advisory
[LEN-73440](https://support.lenovo.com/us/en/product_security/LEN-73440).

List (possibly incomplete) of affected devices not included in the advisory due
to End Of Development Support (EODS):

- S740-14IIL Laptop (IdeaPad)
- Yoga S740-14IIL Laptop (IdeaPad)
- 530S-14IKB Laptop (IdeaPad)
- 530S-15IKB Laptop (IdeaPad)
- 330-14IGM Laptop (IdeaPad)
- 330-15IGM Laptop (IdeaPad)
- 330-14IKB Laptop (IdeaPad)
- 330-15IKB Laptop (IdeaPad)

## Impact

High - Disabled SPI flash firmware storage protections expose users to the risk
of SPI flash implant (UEFI rootkit) installation.

## Exploitability

Medium - Vulnerability can be exploited from a privileged user-mode process by
simply creating special UEFI NVRAM variable.

As long as the variable is created, SPI flash write-protections will be
disabled from the next boot.


## Technical Details

When a UEFI driver named ``SecureBackDoor``
(``32F16D8C-C094-4102-BD6C-1E533F8810F4``) detects existence of the special UEFI
NVRAM variable during the early stages of the boot, it skips the code
responsible for setting the SPI flash write-protections, namely BIOS Control
register and Protected Range Registers, and thus exposes users to the risk of
unauthorized SPI flash modification by attackers.

## Resolution

Update system firmware to the version (or newer) indicated for your model in
the Product Impact section of Lenovo's security advisory LEN-73440.

## Reporter

This vulnerability was discovered and reported by Martin Smolár.

## Disclosure Timeline

- 11 October 2021    — Issue reported to Lenovo
- 12 October 2021    — Lenovo responded and confirmed to investigate the issues
- 17 November 2021   — Lenovo confirmed the vulnerabilities and informed us
                       about the planned advisory publication date (February 8th)
- 20 January 2022    — Lenovo asked to postpone public disclosure to the new
                       advisory publication date to April 18th due to
                       encountered development problems
- 18 April 2022      — Lenovo security advisory published
- 19 April 2022      — ESET's public disclosure


## References

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-3971
- https://support.lenovo.com/us/en/product_security/LEN-73440
- https://www.welivesecurity.com/2022/04/19/when-secure-isnt-secure-uefi-vulnerabilities-lenovo-consumer-laptops/
